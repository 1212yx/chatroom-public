{% extends session.base_layout %}

{% block title %}AI分析与报告{% endblock %}

{% block content %}
<style>
    :root {
        --tech-bg: #0b1120;
        --tech-card-bg: #1e293b;
        --tech-border: rgba(56, 189, 248, 0.3);
        --tech-text-main: #e2e8f0;
        --tech-text-muted: #94a3b8;
        --tech-accent: #38bdf8;
        --tech-accent-glow: rgba(56, 189, 248, 0.5);
        --tech-user-msg-bg: linear-gradient(135deg, #0ea5e9 0%, #2563eb 100%);
        --tech-ai-msg-bg: #0f172a;
        --tech-success: #10b981;
    }

    .layui-card {
        background-color: var(--tech-bg);
        border: 1px solid var(--tech-border);
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        color: var(--tech-text-main);
    }

    .layui-card-header {
        background-color: rgba(30, 41, 59, 0.8);
        border-bottom: 1px solid var(--tech-border);
        color: var(--tech-accent);
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        font-weight: 600;
        letter-spacing: 1px;
    }

    .tech-badge {
        background: rgba(16, 185, 129, 0.2) !important;
        color: #34d399 !important;
        border: 1px solid rgba(16, 185, 129, 0.4);
        border-radius: 4px;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 600px;
        max-height: calc(100vh - 180px);
        background-color: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--tech-border);
        border-radius: 8px;
        margin-top: 15px;
        backdrop-filter: blur(10px);
        box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    /* Grid pattern background effect */
    .chat-container::before {
        content: '';
        position: absolute;
        top: 0; left: 0; right: 0; bottom: 0;
        background-image: 
            linear-gradient(rgba(56, 189, 248, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(56, 189, 248, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        pointer-events: none;
        z-index: 0;
    }
    
    .chat-history {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        position: relative;
        z-index: 1;
    }

    /* Custom Scrollbar */
    .chat-history::-webkit-scrollbar {
        width: 8px;
    }
    .chat-history::-webkit-scrollbar-track {
        background: rgba(15, 23, 42, 0.5);
    }
    .chat-history::-webkit-scrollbar-thumb {
        background: var(--tech-border);
        border-radius: 4px;
    }
    .chat-history::-webkit-scrollbar-thumb:hover {
        background: var(--tech-accent);
    }
    
    .chat-message {
        margin-bottom: 25px;
        display: flex;
        flex-direction: column;
        animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .chat-message.user {
        align-items: flex-end;
    }
    
    .chat-message.assistant {
        align-items: flex-start;
    }
    
    .message-content {
        max-width: 85%;
        padding: 12px 18px;
        border-radius: 12px;
        position: relative;
        word-wrap: break-word;
        font-size: 14px;
        line-height: 1.6;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }
    
    .chat-message.user .message-content {
        background: var(--tech-user-msg-bg);
        color: #fff;
        border-bottom-right-radius: 2px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-message.assistant .message-content {
        background-color: var(--tech-ai-msg-bg);
        color: var(--tech-text-main);
        border: 1px solid var(--tech-border);
        border-bottom-left-radius: 2px;
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.1);
    }
    
    .message-meta {
        font-size: 11px;
        color: var(--tech-text-muted);
        margin-top: 6px;
        padding: 0 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .chat-input-area {
        padding: 15px;
        background-color: rgba(15, 23, 42, 0.8);
        border-top: 1px solid var(--tech-border);
        display: flex;
        gap: 15px;
        z-index: 2;
        backdrop-filter: blur(5px);
    }
    
    .chat-input-area textarea {
        flex: 1;
        height: 50px;
        resize: none;
        background-color: rgba(30, 41, 59, 0.5);
        border: 1px solid var(--tech-border);
        border-radius: 6px;
        padding: 12px;
        font-family: inherit;
        color: var(--tech-text-main);
        transition: all 0.3s ease;
    }
    
    .chat-input-area textarea:focus {
        border-color: var(--tech-accent);
        box-shadow: 0 0 10px var(--tech-accent-glow);
        outline: none;
        background-color: rgba(30, 41, 59, 0.8);
    }
    
    .chat-input-area button {
        height: 50px;
        width: 100px;
        background: var(--tech-user-msg-bg);
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 12px;
    }

    .chat-input-area button:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 15px var(--tech-accent-glow);
    }
    
    .chat-input-area button:disabled {
        background: #475569;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .workflow-container {
        margin-bottom: 15px;
        background: rgba(30, 41, 59, 0.3);
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .workflow-status-text {
        font-size: 12px;
        color: var(--tech-accent);
        margin-bottom: 8px;
        font-family: monospace;
    }

    .workflow-steps {
        display: flex;
        gap: 10px;
    }

    .workflow-step {
        flex: 1;
        text-align: center;
        border-radius: 4px;
        padding: 6px 8px;
        font-size: 11px;
        background-color: rgba(15, 23, 42, 0.5);
        color: var(--tech-text-muted);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        border: 1px solid transparent;
        transition: all 0.3s;
        font-family: monospace;
    }

    .workflow-step.active {
        background-color: rgba(56, 189, 248, 0.1);
        color: var(--tech-accent);
        border-color: var(--tech-accent);
        box-shadow: 0 0 8px var(--tech-accent-glow);
    }

    .workflow-step.done {
        background-color: rgba(16, 185, 129, 0.1);
        color: var(--tech-success);
        border-color: var(--tech-success);
    }

    /* Select Dropdown Styling */
    #modelSelect {
        background-color: rgba(30, 41, 59, 0.8);
        border: 1px solid var(--tech-border);
        color: var(--tech-text-main);
    }
    #modelSelect option {
        background-color: var(--tech-card-bg);
    }

    /* Markdown Styles Dark Mode Override */
    .markdown-body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        color: var(--tech-text-main);
    }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 { 
        color: #fff; 
        border-bottom-color: rgba(255,255,255,0.1);
    }
    .markdown-body code { 
        background-color: rgba(255,255,255,0.1); 
        color: var(--tech-accent);
        border-radius: 4px;
    }
    .markdown-body pre { 
        background-color: #0d1117; 
        border: 1px solid rgba(255,255,255,0.1);
    }
    .markdown-body table th { background-color: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.1); }
    .markdown-body table td { border-color: rgba(255,255,255,0.1); }
    .markdown-body blockquote { border-left-color: var(--tech-accent); color: var(--tech-text-muted); }
    .markdown-body a { color: var(--tech-accent); }
    
    .typing-indicator::after {
        content: '...';
        animation: typing 1.5s infinite;
        color: var(--tech-accent);
    }
    
    @keyframes typing {
        0% { content: '.'; }
        33% { content: '..'; }
        66% { content: '...'; }
    }
</style>

<div class="layui-card">
    <div class="layui-card-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <i class="layui-icon layui-icon-engine" style="color: var(--tech-accent); margin-right: 5px;"></i>
            AI 智能分析中枢
            <span class="layui-badge tech-badge" style="margin-left: 10px;">LIVE</span>
        </div>
        <div style="width: 250px;">
            <select id="modelSelect" class="layui-input" style="height: 30px; padding: 0 10px;">
                {% for model in models %}
                <option value="{{ model.id }}" {% if model.is_default %}selected{% endif %}>{{ model.name }} ({{ model.model_name }})</option>
                {% endfor %}
            </select>
        </div>
    </div>
    <div class="layui-card-body">
        <div class="workflow-container">
            <div class="workflow-status-text" id="workflowStatusText">
                <i class="layui-icon layui-icon-console"></i> 系统就绪，等待指令...
            </div>
            <div class="workflow-steps">
                <div class="workflow-step active" data-step="1">1. 指令解析</div>
                <div class="workflow-step" data-step="2">2. 数据检索</div>
                <div class="workflow-step" data-step="3">3. 智能分析</div>
                <div class="workflow-step" data-step="4">4. 报告生成</div>
            </div>
        </div>
        <div class="chat-container">
            <div class="chat-history" id="chatHistory">
                <div class="chat-message assistant">
                    <div class="message-content markdown-body">
                        **欢迎访问 AI 数据分析中枢**
                        
                        我是您的智能数据分析助手。我已连接到系统核心数据库，可以为您提供实时的业务洞察。
                        
                        您可以尝试向我发送以下指令：
                        
                        *   `SYSTEM_CHECK` : 分析当前系统运行状态及用户注册情况
                        *   `GROUP_ANALYSIS` : 扫描群组活跃度与消息趋势
                        *   `REPORT_GEN` : 生成本周的综合运营报告
                    </div>
                    <div class="message-meta">AI CORE SYSTEM</div>
                </div>
            </div>
            <div class="chat-input-area">
                <textarea id="chatInput" placeholder="请输入分析指令或自然语言问题... (Ctrl+Enter 发送)"></textarea>
                <button class="layui-btn" id="sendBtn">
                    <i class="layui-icon layui-icon-release"></i> 执行
                </button>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='lib/marked/marked.min.js') }}"></script>
<script>
layui.use(['layer', 'jquery'], function(){
    var layer = layui.layer;
    var $ = layui.jquery;
    
    var chatHistory = $('#chatHistory');
    var chatInput = $('#chatInput');
    var sendBtn = $('#sendBtn');
    var isGenerating = false;
    var workflowStatusText = $('#workflowStatusText');

    function resetWorkflow() {
        workflowStatusText.html('<i class="layui-icon layui-icon-console"></i> 系统就绪，等待指令...');
        $('.workflow-step').removeClass('active done');
        $('.workflow-step[data-step="1"]').addClass('active');
    }

    function updateWorkflowFromServer(data) {
        if (!data) {
            return;
        }
        var step = data.step || 0;
        var text = data.status || '';
        if (text) {
            workflowStatusText.html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> ' + text);
        }
        if (!step) {
            return;
        }
        $('.workflow-step').each(function(){
            var s = parseInt($(this).data('step'));
            $(this).removeClass('active done');
            if (s < step) {
                $(this).addClass('done');
            } else if (s === step) {
                $(this).addClass('active');
            }
        });
    }
    
    function scrollToBottom() {
        chatHistory.scrollTop(chatHistory[0].scrollHeight);
    }
    
    function appendUserMessage(content) {
        var html = `
            <div class="chat-message user">
                <div class="message-content">${content.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                <div class="message-meta">OPERATOR</div>
            </div>
        `;
        chatHistory.append(html);
        scrollToBottom();
    }
    
    function appendAssistantMessage() {
        var id = 'msg-' + new Date().getTime();
        var html = `
            <div class="chat-message assistant">
                <div class="message-content markdown-body" id="${id}"><span class="typing-indicator">正在计算</span></div>
                <div class="message-meta">AI CORE SYSTEM</div>
            </div>
        `;
        chatHistory.append(html);
        scrollToBottom();
        return id;
    }
    
    function sendMessage() {
        if (isGenerating) return;
        
        var content = chatInput.val().trim();
        var modelId = $('#modelSelect').val();
        if (!content) return;
        
        chatInput.val('');
        appendUserMessage(content);
        
        resetWorkflow();
        workflowStatusText.html('<i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i> 正在初始化神经连接...');
        
        isGenerating = true;
        sendBtn.addClass('layui-btn-disabled').prop('disabled', true);
        sendBtn.html('<i class="layui-icon layui-icon-loading-1 layui-anim layui-anim-rotate layui-anim-loop"></i> 计算中');
        
        var msgId = appendAssistantMessage();
        var msgContent = $('#' + msgId);
        var fullText = '';
        
        fetch("{{ url_for('admin.ai_analysis_chat') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
                message: content,
                model_id: modelId
            })
        }).then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            
            msgContent.html(''); // Clear typing indicator
            
            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        isGenerating = false;
                        sendBtn.removeClass('layui-btn-disabled').prop('disabled', false);
                        sendBtn.html('<i class="layui-icon layui-icon-release"></i> 执行');
                        workflowStatusText.html('<i class="layui-icon layui-icon-ok-circle"></i> 任务执行完毕');
                        return;
                    }
                    
                    const chunk = decoder.decode(value, { stream: true });
                    // Process SSE format: data: ... \n\n
                    const lines = chunk.split('\n\n');
                    
                    lines.forEach(line => {
                        if (line.startsWith('data: ')) {
                            const data = line.substring(6);
                            if (data === '[DONE]') {
                                return;
                            }
                            try {
                                const json = JSON.parse(data);
                                if (json.type === 'status' && json.status) {
                                    updateWorkflowFromServer(json);
                                } else if (json.content) {
                                    fullText += json.content;
                                    msgContent.html(marked.parse(fullText));
                                    scrollToBottom();
                                } else if (json.error) {
                                    msgContent.html('<span style="color:#ef4444">System Error: ' + json.error + '</span>');
                                }
                            } catch (e) {
                                console.error('Error parsing SSE data', e);
                            }
                        }
                    });
                    
                    read();
                });
            }
            
            read();
            
        }).catch(error => {
            console.error('Fetch error:', error);
            msgContent.html('<span style="color:#ef4444">连接中断，请检查网络节点。</span>');
            isGenerating = false;
            sendBtn.removeClass('layui-btn-disabled').prop('disabled', false);
            sendBtn.html('<i class="layui-icon layui-icon-release"></i> 执行');
        });
    }
    
    sendBtn.on('click', sendMessage);
    
    chatInput.on('keydown', function(e) {
        if (e.ctrlKey && e.keyCode === 13) {
            sendMessage();
        }
    });
    
    resetWorkflow();
});
</script>
{% endblock %}
